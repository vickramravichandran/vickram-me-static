
<!DOCTYPE html>
<!--[if IE]><![endif]-->
<!--[if lt IE 7 ]> <html lang="en" class="ie6"> <![endif]-->
<!--[if IE 7]> <html lang="en" class="ie7"> <![endif]-->
<!--[if IE 8]> <html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9 ]> <html lang="en" class="ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!-->
<html lang="en">
<!--<![endif]-->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="msvalidate.01" content="" />

    <title>NLog {asp-server-variables} renderer for ASP.NET | Vickram Ravichandran</title>

    
<link rel="shortcut icon" href="/static/favicons/favicon.ico">
<link rel="apple-touch-icon" sizes="57x57" href="/static/favicons/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/static/favicons/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/static/favicons/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/static/favicons/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/static/favicons/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/static/favicons/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/static/favicons/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/static/favicons/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/static/favicons/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/static/favicons/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="192x192" href="/static/favicons/android-icon-192x192.png">
<link rel="manifest" href="/static/favicons/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/static/favicons/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">


    <link href='https://fonts.googleapis.com/css?family=Roboto:400,700,500,400italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,700' rel='stylesheet' type='text/css'>
    
    
    <link rel="canonical" href="http://www.vickram.me/nlog-asp-server-variables-renderer-for-asp-net" />
    <meta name="keywords" content="nlog, c#, asp.net" />

    
<meta property="og:site_name" content="Vickram Ravichandran" />
<meta property="og:type" content="article" />
<meta property="og:title" content="NLog {asp-server-variables} renderer for ASP.NET" />
<meta property="og:description" content="The NLog {asp-request} layout renderer requires specifying the keys in the nlog.config file. This works well if we need to log only a few keys. Otherwise, this approach will make the config file difficult to maintain." />
<meta property="og:url" content="http://www.vickram.me/nlog-asp-server-variables-renderer-for-asp-net" />

    <meta property="article:tag" content="nlog" />
    <meta property="article:tag" content="c#" />
    <meta property="article:tag" content="asp.net" />

    
<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="NLog {asp-server-variables} renderer for ASP.NET" />
<meta name="twitter:description" content="The NLog {asp-request} layout renderer requires specifying the keys in the nlog.config file. This works well if we need to log only a few keys. Otherwise, this approach will make the config file difficult to maintain." />
<meta name="twitter:url" content="http://www.vickram.me/nlog-asp-server-variables-renderer-for-asp-net" />
<meta name="twitter:label1" content="Written by" />
<meta name="twitter:data1" content="Vickram Ravichandran" />
<meta name="twitter:label2" content="Filed under" />
<meta name="twitter:data2" content="nlog, c#, asp.net" />


    
<script type="application/ld+json">
    {
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Vickram Ravichandran",
        "logo": "https://vickram.blob.core.windows.net/images/vickram-ravichandran.png?sv=2017-04-17&ss=b&srt=o&sp=r&se=2050-10-15T01:20:16Z&st=2017-10-14T17:20:16Z&spr=https&sig=HW39593GSHaPDTL%2F1BqWDWOaNQczc5ZGnPLRzUswd8k%3D"
    },
    "author": {
        "@type": "Person",
        "name": "Vickram Ravichandran",
        "url": "http://www.vickram.me/author/vickramravichandran/",
        "sameAs": [ "https://www.linkedin.com/in/vickramravichandran" ]
    },
    "headline": "NLog {asp-server-variables} renderer for ASP.NET",
    "url": "http://www.vickram.me/nlog-asp-server-variables-renderer-for-asp-net",
    "keywords": "nlog, c#, asp.net",
    "description": "The NLog {asp-request} layout renderer requires specifying the keys in the nlog.config file. This works well if we need to log only a few keys. Otherwise, this approach will make the config file difficult to maintain.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://www.vickram.me"
        }
    }
</script>





    
<script type="application/ld+json">
    {
        "@context": "http://schema.org/",
        "@type": "Person",
        "name": "Vickram Ravichandran",
        "image":"https://vickram.blob.core.windows.net/images/vickram-ravichandran.png?sv=2017-04-17&ss=b&srt=o&sp=r&se=2050-10-15T01:20:16Z&st=2017-10-14T17:20:16Z&spr=https&sig=HW39593GSHaPDTL%2F1BqWDWOaNQczc5ZGnPLRzUswd8k%3D",
        "jobTitle": "Senior Software Engineer",
        "url": "http://www.vickram.me",
        "sameAs" : [ https://www.linkedin.com/in/vickramravichandran, "http://www.vickramravichandran.com" ]
    }
</script>


    <link href="../app.css?v=mIPojOEcdz6Ph8_jbR0rTCs2IrCTDCJgDc6iGtpOEns1" rel="stylesheet"/>


    
    

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body>
    


<div class="sidebar">

    <header class="header" role="banner">
        <a href="http://www.vickram.me">
            <img id="blog" class="logo" src="https://vickram.blob.core.windows.net/images/vickram-ravichandran.png?sv=2017-04-17&ss=b&srt=o&sp=r&se=2050-10-15T01:20:16Z&st=2017-10-14T17:20:16Z&spr=https&sig=HW39593GSHaPDTL%2F1BqWDWOaNQczc5ZGnPLRzUswd8k%3D">
        </a>
        
        <h1 class="title">
            <a href="http://www.vickram.me" style="text-decoration:none">Vickram Ravichandran</a>
        </h1>
        <p class="description"></p>

        <div class="separator"></div>
        
        <nav class="main-nav responsive">
            <ul>
                <li><a href="http://www.vickram.me">Home</a></li>
            </ul>
        </nav>

        <div class="social-icons">
            <a href="http://www.vickram.me" class="icon icon-home"></a>
            <a href="https://www.linkedin.com/in/vickramravichandran" class="icon icon-linkedin"></a>
            <a href="https://github.com/vickramravichandran" class="icon icon-github-circled"></a>
        </div>

    </header>

</div>


    <div class="content">
        <main role="main">
            

<link rel="amphtml" href="http://www.vickram.me/nlog-asp-server-variables-renderer-for-asp-net/amp/" />



<article class="post tag-nlog, tag-c, tag-asp-net" role="article" itemscope itemtype="http://schema.org/Article">
    <h1 class="post-title">NLog {asp-server-variables} renderer for ASP.NET</h1>
    <span class="post-meta">
        
        by Vickram Ravichandran
    </span>
    <section class="post-content">
        <p>The NLog <code>{asp-request}</code> layout renderer requires specifying the keys in the <code>nlog.config</code> file. This works well if there are only few keys to log or we know exactly what we are looking for. If we need to log many keys this quickly becomes verbose as seen in the markup below.</p>
<pre><code class="language-markup">&lt;target
  xsi:type=&quot;File&quot;
  layout=&quot;${asp-request:form=full_name}
          ${asp-request:form=ship_address}
          ${asp-request:form=home_address}
          ${asp-request:form=email_address}
          ${asp-request:form=city}
          ${asp-request:form=state}
          ${asp-request:form=zip_code}&gt;
&lt;/target&gt;
</code></pre>
<p>I wanted to log all the key/value pairs for a particular page to troubleshoot an intermittent bug. I was not able to find a layout renderer that did what I wanted so I decided to write one.</p>
<p>First copy the <code>AspServerVariableLayoutRenderer</code> class to your project. I format the log as html because I wanted to get a nicely formatted email.</p>
<pre><code class="language-csharp">using NLog;
using NLog.LayoutRenderers;

namespace App.Web.Helpers
{
    [LayoutRenderer(&quot;asp-server-variables&quot;)]
    public class AspServerVariableLayoutRenderer : LayoutRenderer
    {
        protected override void Append(StringBuilder builder, LogEventInfo logEvent)
        {
            var html = builder;

            html.AppendFormat(&quot;&lt;h1 style='font-size: small;'&gt;Request &amp; Server Variables&lt;/h1&gt;&quot;);

            html.Append(&quot;&lt;table cellpadding='5' cellspacing='0' border='1'&gt;&quot;);

            // form variables
            foreach (string key in HttpContext.Current.Request.Form.AllKeys)
            {
                // skip logging certain known name/value pairs
                if (key.IndexOf(&quot;__VIEWSTATE&quot;, StringComparison.OrdinalIgnoreCase) != -1
                    || key.Equals(&quot;__SCROLLPOSITIONX&quot;, StringComparison.OrdinalIgnoreCase)
                    || key.Equals(&quot;__SCROLLPOSITIONY&quot;, StringComparison.OrdinalIgnoreCase)
                    || key.Equals(&quot;__EVENTVALIDATION&quot;, StringComparison.OrdinalIgnoreCase)
                    || key.IndexOf(&quot;password&quot;, StringComparison.OrdinalIgnoreCase) != -1
                    )
                {
                    continue;
                }

                html.AppendFormat(&quot;&lt;tr&gt;&lt;td&gt;{0}&lt;/td&gt;&lt;td&gt;{1}&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;&quot;,
                    HttpContext.Current.Server.HtmlEncode(key),
                    HttpContext.Current.Server.HtmlEncode(HttpContext.Current.Request.Form[key]));
            }

            // server variables
            foreach (string key in HttpContext.Current.Request.ServerVariables.AllKeys)
            {
                // skip logging certain known name/value pairs
                if (key.Equals(&quot;ALL_HTTP&quot;, StringComparison.OrdinalIgnoreCase)
                    || key.Equals(&quot;ALL_RAW&quot;, StringComparison.OrdinalIgnoreCase)
                    || key.Equals(&quot;HTTP_ACCEPT&quot;, StringComparison.OrdinalIgnoreCase)
                    || key.Equals(&quot;HTTP_ACCEPT_ENCODING&quot;, StringComparison.OrdinalIgnoreCase)
                    || key.Equals(&quot;HTTP_ACCEPT_LANGUAGE&quot;, StringComparison.OrdinalIgnoreCase)
                    || key.Equals(&quot;HTTP_COOKIE&quot;, StringComparison.OrdinalIgnoreCase)
                    || key.StartsWith(&quot;CERT_&quot;, StringComparison.OrdinalIgnoreCase)
                    || key.IndexOf(&quot;password&quot;, StringComparison.OrdinalIgnoreCase) != -1
                    )
                {
                    continue;
                }

                html.AppendFormat(&quot;&lt;tr&gt;&lt;td&gt;{0}&lt;/td&gt;&lt;td&gt;{1}&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;&quot;,
                    HttpContext.Current.Server.HtmlEncode(key),
                    HttpContext.Current.Server.HtmlEncode(HttpContext.Current.Request.ServerVariables[key]));
            }

            html.Append(&quot;&lt;/table&gt;&quot;);
        }
    }
}
</code></pre>
<p>Next register the custom layout renderer in the application start event in the <code>Global.asax.cs</code> file.</p>
<pre><code class="language-csharp">using App.Web.Helpers;

public class Global : HttpApplication
{
    protected void Application_Start(object sender, EventArgs e)
    {
        // register custom nlog renderer as the first thing when the app starts
        ConfigurationItemFactory
                  .Default
                  .LayoutRenderers
                  .RegisterDefinition(&quot;asp-server-variables&quot;, typeof(AspServerVariableLayoutRenderer));
    }
}
</code></pre>
<p>Finally use the <code>{asp-server-variables}</code> layout renderer in the <code>nlog.config</code> file.</p>
<pre><code class="language-markup">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;
&lt;nlog xmlns=&quot;http://www.nlog-project.org/schemas/NLog.xsd&quot;
      xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;  
    &lt;targets&gt;
        &lt;target xsi:type=&quot;Mail&quot;
                name=&quot;MailTarget&quot;&gt;
            &lt;body xsi:type=&quot;SimpleLayout&quot;&gt;
                &lt;text&gt;
                    &lt;![CDATA[
                        &lt;html&gt;
                            &lt;body&gt;
                                ${asp-server-variables}
                            &lt;/body&gt;
                        &lt;/html&gt;
                    ]]&gt;
                &lt;/text&gt;
            &lt;/body&gt;
        &lt;/target&gt;
    &lt;/targets&gt;

    &lt;rules&gt;
        &lt;logger name=&quot;PageLogger&quot; minlevel=&quot;Debug&quot; writeTo=&quot;MailTarget&quot;/&gt;
    &lt;/rules&gt;
&lt;/nlog&gt;
</code></pre>
<p>It is important to turn off the logger after its purpose is over. Definitely not recommended for use in a production environment.</p>
<p>Related</p>
<p>https://github.com/NLog/NLog/blob/master/src/NLog/LayoutRenderers/AspRequestValueLayoutRenderer.cs</p>

    </section>

    
<div class="post-meta">
    <div class="post-tags icon-tag">
            <a href="/tag/nlog/">nlog</a>  •             <a href="/tag/c/">c#</a>  •             <a href="/tag/asp-net/">asp.net</a>     </div>
</div>

    

<footer class="post-footer">
    <section class="share">
        <h4 class="post-share">Share this post</h4>
        <ul>
            <li>
                <a href="https://plus.google.com/share?url=http://www.vickram.me/nlog-asp-server-variables-renderer-for-asp-net"
                    onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <i class="icon icon-gplus"></i>
                </a>
            </li>
            <li>
                <a href="https://twitter.com/share?text=NLog+%7Basp-server-variables%7D+renderer+for+ASP.NET;url=http://www.vickram.me/nlog-asp-server-variables-renderer-for-asp-net"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <i class="icon icon-twitter"></i>
                </a>
            </li>
            <li>
                <a href="https://www.facebook.com/sharer/sharer.php?u=http://www.vickram.me/nlog-asp-server-variables-renderer-for-asp-net"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <i class="icon icon-facebook"></i>
                </a>
            </li>
        </ul>
    </section>
</footer>

    
<section class="post-comments">
    <div id="disqus_thread"></div>
    <script>
        /**
        * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
        * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
        */

        var disqus_config = function () {
            this.page.url = "http://www.vickram.me/nlog-asp-server-variables-renderer-for-asp-net";
            this.page.identifier = "nlog-asp-server-variables-renderer-for-asp-net";
            this.page.title = "NLog {asp-server-variables} renderer for ASP.NET";
        };

        (function () { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');

            s.src = '//vickram.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</section>

</article>


        </main>
    </div>

    <script src="../app.js?v=_QvRy-x53dGG35wUxtaekHJdHwwEkHFwZztABa1JJJM1"></script>


</body>
</html>
